#### Step 1: Generate the Bootstrap token:
```sh
cat > bootstrap-token.yaml <<EOF
apiVersion: v1
kind: Secret
metadata:
  name: bootstrap-token-07401b
  namespace: kube-system

type: bootstrap.kubernetes.io/token
stringData:
  description: "The default bootstrap token generated by 'kubeadm init'."

  # Token ID and secret. Required.
  token-id: 07401b
  token-secret: f395accd246ae52d

  # Expiration. Optional.
  expiration: 2025-03-10T03:22:11Z

  # Allowed usages.
  usage-bootstrap-authentication: "true"
  usage-bootstrap-signing: "true"

  # Extra groups to authenticate the token as. Must start with "system:bootstrappers:"
  auth-extra-groups: system:bootstrappers:worker,system:bootstrappers:ingress
EOF
```
#### Step 2: Allow kube-apiserver to accept bootstrap tokens:
```sh
--enable-bootstrap-token-auth=true
```
#### Step 3: Bind the Group with ClusterRole
```sh
cat > bootstrapping-role.yaml <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: create-csrs-for-bootstrapping
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:node-bootstrapper
  apiGroup: rbac.authorization.k8s.io
EOF
```
```sh
kubectl apply -f bootstrapping-role.yaml
```

#### Step 4: Allow Kubelet to Approve CSR
```sh
cat > auto-approve-csrs-for-group.yaml <<EOF
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: auto-approve-csrs-for-group
subjects:
- kind: Group
  name: system:bootstrappers
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: system:certificates.k8s.io:certificatesigningrequests:nodeclient
  apiGroup: rbac.authorization.k8s.io
EOF
```
```sh
kubectl apply -f auto-approve-csrs-for-group.yaml
```
#### Step 5: Verify Controller Manager Configuration
```sh
--cluster-signing-cert-file=/var/lib/kubernetes/ca.crt \\
--cluster-signing-key-file=/var/lib/kubernetes/ca.key \\
```

### Worker Node Configuration 
```sh
setenforce 0
sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
yum -y install docker && systemctl start docker && systemctl enable docker
yum -y install socat conntrack ipset wget nano
sysctl -w net.ipv4.conf.all.forwarding=1
mkdir /var/lib/kubelet
mkdir /var/lib/kubernetes
mkdir /var/lib/kube-proxy

mkdir /root/binaries && cd /root/binaries
wget https://dl.k8s.io/v1.15.0/kubernetes-node-linux-amd64.tar.gz
tar -xzvf kubernetes-node-linux-amd64.tar.gz
cp /root/binaries/kubernetes/node/bin/kubectl /usr/local/bin
cp /root/binaries/kubernetes/node/bin/kubelet /usr/local/bin
cp /root/binaries/kubernetes/node/bin/kube-proxy /usr/local/bin
```
#### 2. Create BootStrap Based KubeConfig file:
```sh
cd /var/lib/kubelet
```
```sh
cat > bootstrap-kubeconfig <<EOF
apiVersion: v1
kind: Config
clusters:
- cluster:
    certificate-authority: "/var/lib/kubernetes/ca.crt"
    server: https://134.209.158.242:6443
  name: bootstrap
contexts:
- context:
    cluster: bootstrap
    user: kubelet-bootstrap
  name: bootstrap
current-context: bootstrap
preferences: {}
users:
- name: kubelet-bootstrap
  user:
    token: 07401b.f395accd246ae52d
EOF
```
##### Important: Make sure you have CA certificate file (ca.crt) in /var/lib/kubernetes directory.
.

#### Step 3: Create a Kubelet Configuration File:
```sh
cd /var/lib/kubelet
```
```sh
cat <<EOF | sudo tee /var/lib/kubelet/kubelet-config.yaml
kind: KubeletConfiguration
apiVersion: kubelet.config.k8s.io/v1beta1
authentication:
  anonymous:
    enabled: false
  webhook:
    enabled: true
  x509:
    clientCAFile: /var/lib/kubernetes/ca.crt
authorization:
  mode: Webhook
clusterDomain: "cluster.local"
clusterDNS:
  - "10.32.0.10"
runtimeRequestTimeout: "15m"
EOF
```

#### Step 4: Create a Kubelet Service:
```sh
cat <<EOF | sudo tee /etc/systemd/system/kubelet.service
[Unit]
Description=Kubernetes Kubelet
Documentation=https://github.com/kubernetes/kubernetes
After=docker.service
Requires=docker.service

[Service]
ExecStart=/usr/local/bin/kubelet \\
  --config=/var/lib/kubelet/kubelet-config.yaml \\
  --image-pull-progress-deadline=2m \\
  --bootstrap-kubeconfig=/var/lib/kubelet/bootstrap-kubeconfig \\
  --kubeconfig=/var/lib/kubelet/kubeconfig \\
  --network-plugin=cni \\
  --register-node=true \\
  --v=2 \\
  --cgroup-driver=systemd \\
  --runtime-cgroups=/systemd/system.slice \\
  --kubelet-cgroups=/systemd/system.slice
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```
#### Step 5: Kube-Proxy Configuration

Copy the kube-proxy.kubeconfig from earlier worker node /var/lib/kube-proxy

##### Generate kube-proxy configuration file:
```sh
cd /var/lib/kube-proxy
```
```sh
cat <<EOF | sudo tee /var/lib/kube-proxy/kube-proxy-config.yaml
kind: KubeProxyConfiguration
apiVersion: kubeproxy.config.k8s.io/v1alpha1
clientConnection:
  kubeconfig: "/var/lib/kube-proxy/kubeconfig"
mode: "iptables"
clusterCIDR: "10.200.0.0/16"
EOF
```
```sh
cat <<EOF | sudo tee /etc/systemd/system/kube-proxy.service
[Unit]
Description=Kubernetes Kube Proxy
Documentation=https://github.com/kubernetes/kubernetes

[Service]
ExecStart=/usr/local/bin/kube-proxy \\
  --config=/var/lib/kube-proxy/kube-proxy-config.yaml
Restart=on-failure
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF
```

## Enable Networking

#### Step 1: Download CNI Plugins:
```sh
wget https://github.com/containernetworking/plugins/releases/download/v0.8.2/cni-plugins-linux-amd64-v0.8.2.tgz
```
#### Step 2: Configure Base Directories:
```sh
mkdir -p \
  /etc/cni/net.d \
  /opt/cni/bin \
  /var/run/kubernetes
```
```sh
mv cni-plugins-linux-amd64-v0.8.2.tgz /usr/cni/bin
cd /opt/cni/bin
tar -xzvf cni-plugins-linux-amd64-v0.8.2.tgz
```
##### Final Step: Start the Service:
```sh
systemctl start kubelet kube-proxy
```
##### Verify at Kubernetes Master if node is registered:
```sh
kubectl get nodes
```
